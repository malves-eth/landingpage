# üõ†Ô∏è Guia de Remedia√ß√£o de Vulnerabilidades

**Projeto:** Alves Cury Financial Landing Page  
**Data:** 19 de Agosto de 2025  
**Status de Seguran√ßa:** **14.3% (CR√çTICO)** üî¥

---

## üìä RESUMO DOS TESTES AUTOMATIZADOS

- **Total de Testes:** 7
- **Aprovados:** 1 ‚úÖ
- **Falharam:** 6 ‚ùå
- **Taxa de Aprova√ß√£o:** 14.3%

---

## üö® VULNERABILIDADES CR√çTICAS (A√á√ÉO IMEDIATA)

### 1. **Falha de Autentica√ß√£o** - SEVERIDADE: CR√çTICA
**Problema:** API sem autentica√ß√£o permite acesso irrestrito aos dados.

**Solu√ß√£o:**
```typescript
// api/src/common/guards/auth.guard.ts
import { Injectable, CanActivate, ExecutionContext, UnauthorizedException } from '@nestjs/common';

@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const apiKey = request.headers['x-api-key'];
    
    if (!apiKey || apiKey !== process.env.API_KEY) {
      throw new UnauthorizedException('Invalid API key');
    }
    
    return true;
  }
}
```

**Implementa√ß√£o:**
```typescript
// api/src/leads/leads.controller.ts
import { UseGuards } from '@nestjs/common';
import { AuthGuard } from '../common/guards/auth.guard';

@Controller('leads')
@UseGuards(AuthGuard) // ‚úÖ Adicionar autentica√ß√£o
export class LeadsController {
  // ... resto do c√≥digo
}
```

### 2. **Inje√ß√£o de HTML em Emails** - SEVERIDADE: ALTA
**Problema:** Dados do usu√°rio inseridos sem sanitiza√ß√£o nos emails.

**Solu√ß√£o:**
```typescript
// api/src/leads/leads.service.ts
import { escapeHtml } from 'escape-html';

private async sendEmailNotification(lead: any) {
  // ‚úÖ Sanitizar dados antes de usar
  const safeData = {
    name: escapeHtml(lead.name),
    whatsapp: escapeHtml(lead.whatsapp),
    state: escapeHtml(lead.state),
    goal: escapeHtml(lead.goal)
  };

  const emailHTML = `
    <h2>üéØ Novo Lead - Seguro de Vida</h2>
    <ul>
      <li><strong>Nome:</strong> ${safeData.name}</li>
      <li><strong>WhatsApp:</strong> ${safeData.whatsapp}</li>
      <li><strong>Estado:</strong> ${safeData.state}</li>
      <li><strong>Objetivo:</strong> ${safeData.goal}</li>
    </ul>
  `;
  // ... resto do c√≥digo
}
```

**Instalar depend√™ncia:**
```bash
cd api && npm install escape-html @types/escape-html
```

---

## üîß CORRE√á√ïES DE CONFIGURA√á√ÉO

### 3. **Credenciais Inseguras** - SEVERIDADE: ALTA
**Problema:** Credenciais de teste no arquivo `.env`.

**Corre√ß√£o Imediata:**
```bash
# api/.env - SUBSTITUIR IMEDIATAMENTE
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="contato@alvescuryfinancial.com"  # ‚úÖ Email real
SMTP_PASS="APP_PASSWORD_FORTE_AQUI"         # ‚úÖ Senha de app forte
```

**Gerar senha de app Gmail:**
1. Acesse [Configura√ß√µes do Gmail](https://myaccount.google.com/apppasswords)
2. Crie uma nova senha de app
3. Use a senha gerada no SMTP_PASS

### 4. **CORS Inseguro** - SEVERIDADE: M√âDIA
**Problema:** CORS permite qualquer origem com credentials.

**Corre√ß√£o:**
```typescript
// api/src/main.ts
app.use(cors({
  origin: process.env.CORS_ORIGIN?.split(',') || ['http://localhost:3000'], // ‚úÖ Apenas origens espec√≠ficas
  credentials: true,
  optionsSuccessStatus: 200
}));
```

---

## üõ°Ô∏è MELHORIAS DE SEGURAN√áA

### 5. **Headers de Seguran√ßa** - SEVERIDADE: M√âDIA
**Instala√ß√£o:**
```bash
cd api && npm install helmet
```

**Implementa√ß√£o:**
```typescript
// api/src/main.ts
import helmet from 'helmet';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // ‚úÖ Configurar headers de seguran√ßa
  app.use(helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"],
      },
    },
    hsts: {
      maxAge: 31536000,
      includeSubDomains: true,
      preload: true
    }
  }));
  
  // ... resto do c√≥digo
}
```

### 6. **Valida√ß√£o Rigorosa de Dados**
**Melhorar DTO:**
```typescript
// api/src/leads/dto/create-lead.dto.ts
import { z } from 'zod';

export const CreateLeadSchema = z.object({
  name: z.string()
    .min(2, 'Nome deve ter pelo menos 2 caracteres')
    .max(100, 'Nome muito longo')
    .regex(/^[a-zA-Z√Ä-√ø\s]+$/, 'Nome deve conter apenas letras'),
  
  whatsapp: z.string()
    .regex(/^\+?[1-9]\d{1,14}$/, 'WhatsApp deve ser um n√∫mero v√°lido'),
  
  state: z.string()
    .min(2, 'Estado inv√°lido')
    .max(50, 'Estado muito longo'),
  
  age: z.number()
    .min(18, 'Idade m√≠nima: 18 anos')
    .max(100, 'Idade m√°xima: 100 anos'),
  
  goal: z.enum([
    'protecao_familiar',
    'investimento',
    'poupanca',
    'outros'
  ], { message: 'Objetivo inv√°lido' })
});

export type CreateLeadDto = z.infer<typeof CreateLeadSchema>;
```

---

## üì¶ CORRE√á√ÉO DE DEPEND√äNCIAS

### 7. **Depend√™ncias Vulner√°veis**
**Corre√ß√£o:**
```bash
# No diret√≥rio web/
npm audit fix

# Se houver problemas, for√ßar updates:
npm audit fix --force

# Verificar novamente:
npm audit
```

---

## üöÄ IMPLEMENTA√á√ÉO PASSO A PASSO

### Prioridade 1 (Implementar HOJE)
```bash
# 1. Corrigir credenciais
nano api/.env

# 2. Instalar depend√™ncias de seguran√ßa
cd api && npm install helmet escape-html @types/escape-html

# 3. Aplicar corre√ß√µes de c√≥digo
# (Usar os c√≥digos fornecidos acima)

# 4. Testar API
npm run start:dev
```

### Prioridade 2 (Esta semana)
```bash
# 1. Atualizar depend√™ncias
cd web && npm audit fix
cd ../api && npm audit fix

# 2. Configurar monitoramento
# 3. Implementar logs de seguran√ßa
```

### Prioridade 3 (Pr√≥ximo m√™s)
```bash
# 1. Implementar autentica√ß√£o completa
# 2. Configurar SSL/TLS em produ√ß√£o
# 3. Auditoria de seguran√ßa regular
```

---

## ‚úÖ VALIDA√á√ÉO DAS CORRE√á√ïES

Ap√≥s implementar as corre√ß√µes, execute:

```bash
# Testar novamente
node security-tests/security-test.js

# Objetivo: Taxa de aprova√ß√£o > 85%
```

---

## üìã CHECKLIST DE IMPLEMENTA√á√ÉO

- [ ] **Corrigir credenciais em `.env`**
- [ ] **Instalar `helmet`, `escape-html`**
- [ ] **Implementar sanitiza√ß√£o de emails**
- [ ] **Configurar CORS restritivo**
- [ ] **Adicionar headers de seguran√ßa**
- [ ] **Corrigir depend√™ncias vulner√°veis**
- [ ] **Implementar autentica√ß√£o b√°sica**
- [ ] **Testar todas as corre√ß√µes**
- [ ] **Re-executar testes de seguran√ßa**
- [ ] **Documentar mudan√ßas**

---

## üéØ META DE SEGURAN√áA

**Status Atual:** 14.3% ‚ùå  
**Meta:** 85% ‚úÖ  
**Prazo:** 7 dias

---

*Este guia cont√©m todas as informa√ß√µes necess√°rias para elevar a seguran√ßa do projeto de 14.3% para 85%+*